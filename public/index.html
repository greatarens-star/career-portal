<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUCCPS Career Portal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background-color: #f0f2f5; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* --- LANDING & SLIDESHOW --- */
        .landing-wrapper { position: relative; width: 100%; min-height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; }
        .landing-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0, 51, 102, 0.9), rgba(0, 51, 102, 0.8)); z-index: 2; }
        .cb-slideshow { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 1; padding: 0; margin: 0; list-style: none; }
        .cb-slideshow li { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0; z-index: 0; animation: imageAnimation 24s linear infinite; }
        .cb-slideshow li:nth-child(1) { background-image: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=2070'); }
        .cb-slideshow li:nth-child(2) { background-image: url('https://images.unsplash.com/photo-1541339907198-e08756dedf3f?q=80&w=2070'); animation-delay: 8s; }
        .cb-slideshow li:nth-child(3) { background-image: url('https://images.unsplash.com/photo-1434030216411-0b793f4b4173?q=80&w=2070'); animation-delay: 16s; }
        @keyframes imageAnimation { 0% { opacity: 0; animation-timing-function: ease-in; } 8% { opacity: 1; animation-timing-function: ease-out; } 25% { opacity: 1; } 33% { opacity: 0; } 100% { opacity: 0; } }

        .landing-content { position: relative; z-index: 10; display: flex; width: 100%; max-width: 1100px; justify-content: space-between; align-items: center; gap: 50px; }
        .flag-strip { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: linear-gradient(90deg, black 33%, #990000 33%, #990000 66%, #006600 66%); z-index: 20; }
        .landing-hero { color: white; flex: 1; }
        .landing-hero h1 { font-size: 3.5rem; font-weight: 700; line-height: 1.2; margin-bottom: 15px; }
        .landing-hero p { font-size: 1.1rem; opacity: 0.9; font-weight: 300; line-height: 1.6; }
        .badge { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: inline-block; color: #fff; }
        
        .auth-box { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 400px; backdrop-filter: blur(10px); border-top: 5px solid #d35400; }
        .auth-box h3 { color: #003366; margin-bottom: 25px; font-weight: 700; text-align: center; }
        .auth-box input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; }
        .link-text { text-align: center; margin-top: 20px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }

        .btn { cursor: pointer; border: none; padding: 14px; border-radius: 6px; font-weight: 600; font-size: 1rem; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .primary-btn { background: #003366; color: white; } .primary-btn:hover { background: #002244; }
        .secondary-btn { background: #27ae60; color: white; } .secondary-btn:hover { background: #1e8449; }
        .download-btn { background: #d35400; color: white; margin-bottom: 15px; }
        .back-btn { background: transparent; color: #666; border: 1px solid #ccc; margin-top: 5px; }

        /* --- APP LAYOUT --- */
        .app-layout { width: 100%; min-height: 100vh; background: #f4f7f6; }
        nav { background: #003366; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 800px; margin: 30px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h2 { color: #003366; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .group-header { background: #003366; color: white; padding: 10px; border-radius: 5px 5px 0 0; margin-top: 20px; font-weight: bold; }
        .group-container { border: 1px solid #ddd; padding: 20px; border-radius: 0 0 5px 5px; background: white; margin-bottom: 20px; }
        .input-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .input-row label { width: 60%; font-weight: 500; }
        .input-row select { width: 35%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .course-card { background: white; border-left: 5px solid #27ae60; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        #pdf-template { width: 100%; max-width: 800px; background: white; padding: 40px; font-family: 'Times New Roman', serif; color: black; display: none; }
        .pdf-header { text-align: center; border-bottom: 2px solid #003366; padding-bottom: 20px; margin-bottom: 20px; }
        .pdf-details { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pdf-table th, .pdf-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .pdf-table th { background-color: #003366; color: white; }

        @media (max-width: 768px) { 
            .landing-wrapper { height: auto; overflow-y: auto; padding: 60px 20px 40px 20px; display: block; }
            .landing-content { flex-direction: column; text-align: center; gap: 30px; }
            .landing-hero { margin-right: 0; margin-bottom: 20px; }
            .landing-hero h1 { font-size: 2.2rem; }
            .auth-box { width: 100%; padding: 25px; } 
            nav { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="score-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:10px; text-align:center; width:90%; max-width:400px; box-shadow:0 5px 20px rgba(0,255,0,0.2);">
            <div style="font-size:3rem;">üéâ</div>
            <h2 id="modal-title" style="color:#003366; margin:10px 0;">Calculation Complete!</h2>
            <p id="modal-subtitle" style="font-size:1.1rem;">Your Weighted Cluster Points:</p>
            <h1 id="modal-points" style="font-size:2.5rem; color:#27ae60; margin:10px 0;">0.000</h1>
            <button onclick="viewCourses()" class="btn primary-btn" style="margin-top:20px;">üëâ See Courses I Qualify For</button>
            <button onclick="closeModal()" style="margin-top:10px; background:transparent; border:none; color:#999; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="pdf-template">
        <div class="pdf-header"><h1>üá∞üá™ KUCCPS Career Portal</h1><h3>Student Qualification Report</h3><p>Generated on: <span id="pdf-date"></span></p></div>
        <div class="pdf-details">
            <p><strong>üë§ Name:</strong> <span id="pdf-name"></span></p>
            <p><strong>üî¢ Index Number:</strong> <span id="pdf-index"></span></p>
            <p><strong>üéì Level:</strong> <span id="pdf-level"></span></p>
            <p><strong>üìä Weighted Points:</strong> <span id="pdf-points" style="color:green; font-weight:bold;"></span></p>
            <p><strong>üéØ Field of Interest:</strong> <span id="pdf-field"></span></p>
        </div>
        <h3>‚úÖ Qualified Courses</h3>
        <table class="pdf-table"><thead><tr><th>Course Name</th><th>Institution</th><th>Requirement</th></tr></thead><tbody id="pdf-course-list"></tbody></table>
        <div style="margin-top: 40px; text-align: center; font-size: 0.9rem; color: #666; border-top: 1px solid #ddd; padding-top: 10px;"><p>Official System Generated Report.</p></div>
    </div>

    <div id="landing-page" class="landing-wrapper">
        <div class="flag-strip"></div><div class="landing-overlay"></div>
        <ul class="cb-slideshow"><li></li><li></li><li></li></ul>
        <div class="landing-content">
            <div class="landing-hero">
                <span class="badge">üá∞üá™ Official Student Portal</span>
                <h1>Kenya Career<br>Placement Portal</h1>
                <p>Securely calculate your Weighted Cluster Points and find your eligible Degree & Diploma courses instantly based on official ministry guidelines.</p>
                <div style="margin-top: 30px; font-size: 0.85rem; opacity: 0.8;"><p>Verified 2026 Edition ‚Ä¢ Secure Login</p></div>
            </div>
            
            <div class="auth-box">
                <div style="text-align:center; margin-bottom:20px;"><div style="width:60px; height:60px; background:#e3f2fd; color:#003366; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:1.5rem;">üéì</div></div>
                
                <div id="auth-selection">
                    <h3>Welcome Student</h3>
                    <p style="text-align:center; margin-bottom:20px; color:#666;">Please choose an option to continue:</p>
                    <button onclick="showLogin()" class="btn primary-btn">Log In</button>
                    <button onclick="showSignup()" class="btn secondary-btn">Create New Account</button>
                </div>

                <form id="loginForm" class="hidden">
                    <h3>Student Login</h3>
                    <input type="number" id="login-index" placeholder="Index Number" required>
                    <input type="password" id="login-pass" placeholder="Password" required>
                    <button type="submit" class="btn primary-btn">Access Portal</button>
                    <button type="button" onclick="showSelection()" class="btn back-btn">‚¨Ö Back</button>
                </form>

                <form id="signupForm" class="hidden">
                    <h3>Register Account</h3>
                    <input type="number" id="signup-index" placeholder="Index Number" required>
                    <input type="text" id="signup-name" placeholder="Full Name" required>
                    <input type="password" id="signup-pass" placeholder="Create Password" required>
                    <button type="submit" class="btn secondary-btn">Create Account</button>
                    <button type="button" onclick="showSelection()" class="btn back-btn">‚¨Ö Back</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-interface" class="app-layout hidden">
        <nav><h1>üá∞üá™ Career Portal</h1><div><span id="nav-username" style="font-weight:bold; margin-right:10px;">User</span><button onclick="location.reload()" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">Logout</button></div></nav>
        <div id="dashboard-section" class="container">
            <h2>üìä Grade Entry Calculator</h2>
            <form id="calculatorForm">
                <div style="background:#e3f2fd; padding:15px; border:1px solid #2196f3; border-radius:8px; margin-bottom:20px;">
                    <label style="font-weight:bold; color:#0d47a1;">üéì Education Level:</label>
                    <select id="education-level" style="width:100%; padding:10px; margin-top:5px; font-weight:bold;"><option value="degree">Degree (University)</option><option value="diploma">Diploma (TVET/College)</option></select>
                </div>
                <div style="background:#fffbf0; padding:15px; border:1px solid orange; border-radius:8px; margin-bottom:20px;">
                    <label style="font-weight:bold;">üèÜ KCSE Mean Grade:</label>
                    <select id="mean-grade" required style="width:100%; padding:8px; margin-top:5px;"><option value="12">A</option><option value="11">A-</option><option value="10">B+</option><option value="9">B</option><option value="8">B-</option><option value="7">C+</option><option value="6">C</option><option value="5">C-</option><option value="4">D+</option><option value="3">D</option><option value="2">D-</option><option value="1">E</option></select>
                </div>
                
                <div class="group-header">üìò Group 1: Compulsory Subjects</div>
                <div class="group-container"><div class="input-row"><label>Mathematics</label> <select id="math" class="grade-select"></select></div><div class="input-row"><label>English</label> <select id="eng" class="grade-select"></select></div><div class="input-row"><label>Kiswahili</label> <select id="kis" class="grade-select"></select></div></div>
                
                <div class="group-header">üß™ Group 2: Sciences</div>
                <div class="group-container"><div class="input-row"><label>Biology</label> <select id="bio" class="grade-select"></select></div><div class="input-row"><label>Physics</label> <select id="phy" class="grade-select"></select></div><div class="input-row"><label>Chemistry</label> <select id="chem" class="grade-select"></select></div></div>
                
                <div class="group-header">üåç Group 3: Humanities</div>
                <div class="group-container"><div class="input-row"><label>History</label> <select id="hist" class="grade-select"></select></div><div class="input-row"><label>Geography</label> <select id="geo" class="grade-select"></select></div><div class="input-row"><label>CRE / IRE / HRE</label> <select id="cre" class="grade-select"></select></div></div>
                
                <div class="group-header">üõ†Ô∏è Group 4 & 5: Technical / Business</div>
                <div class="group-container" style="background: #fffbf0; border: 1px solid orange;"><div class="input-row"><label>Choose Subject Name</label> <select id="tech-subject-name" style="width: 100%; padding: 8px;"></select></div><div class="input-row" style="margin-top:10px;"><label>Enter Grade</label> <select id="tech-subject-grade" class="grade-select"></select></div></div>
                
                <div style="background:#eef2f7; padding:15px; border-left:4px solid #003366; margin-top:20px;">
                    <label style="font-weight:bold;">üéØ Target Career Field:</label>
                    <select id="career-field" style="width:100%; padding:10px; margin-top:5px;"><option value="edu">Education</option><option value="eng">Engineering & Technology</option><option value="med">Health Sciences & Medicine</option><option value="agri">Agriculture</option><option value="biz">Business & Economics</option><option value="law">Law & Administration</option><option value="arts">Arts & Humanities</option><option value="pure">Pure Sciences</option><option value="arch">Built Environment</option><option value="hosp">Hospitality & Tourism</option><option value="media">Media & Creative Arts</option><option value="it">IT & Computing</option></select>
                </div>
                <button type="submit" class="btn primary-btn" style="margin-top:20px;">Calculate & Check</button>
            </form>
        </div>
        <div id="results-page" class="container hidden">
            <button onclick="document.getElementById('results-page').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden');" class="btn secondary-btn" style="margin-bottom:15px;">Back</button>
            <button onclick="downloadPDF()" class="btn download-btn">üì• Download Official Report PDF</button>
            <div class="report-header"><h2>Qualification Report</h2></div>
            <div id="course-list-container"></div>
        </div>
    </div>

    <script>
        // --- 1. GLOBALS & SETUP ---
        let fetchedCourses = [];
        let currentStudent = { name: "Student", index: "0000", hasPaid: 0 }; 
        let currentPoints = 0;

        // Dropdowns setup
        const gradeList = [{val:12,txt:"A"},{val:11,txt:"A-"},{val:10,txt:"B+"},{val:9,txt:"B"},{val:8,txt:"B-"},{val:7,txt:"C+"},{val:6,txt:"C"},{val:5,txt:"C-"},{val:4,txt:"D+"},{val:3,txt:"D"},{val:2,txt:"D-"},{val:1,txt:"E"},{val:0,txt:"Not Taken"}];
        document.querySelectorAll('.grade-select').forEach(s => gradeList.forEach(g => { let o=document.createElement('option'); o.value=g.val; o.innerText=g.txt; if(g.val===0)o.selected=true; s.appendChild(o); }));
        const techSubjects = ["Agriculture","Business Studies","Computer Studies","Home Science","French","German","Music","Aviation"];
        techSubjects.forEach(s => { let o=document.createElement('option'); o.value=s; o.innerText=s; document.getElementById('tech-subject-name').appendChild(o); });

        // --- 2. SWITCHING SCREENS (NEW) ---
        function showLogin() {
            document.getElementById('auth-selection').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }
        function showSignup() {
            document.getElementById('auth-selection').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }
        function showSelection() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('auth-selection').classList.remove('hidden');
        }

        // --- 3. AUTH FUNCTION ---
        const handleAuth = async (url, data, isLogin, hideId) => {
            try {
                const res = await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(data) 
                });
                const json = await res.json();
                
                if(res.ok) {
                    if(!isLogin) { 
                        // --- SIGNUP SUCCESS ---
                        alert("Account Created Successfully! ‚úÖ\nPlease Login now."); 
                        showLogin(); // Go to login screen
                        
                        // Clear Inputs
                        document.getElementById('signup-index').value = '';
                        document.getElementById('signup-name').value = '';
                        document.getElementById('signup-pass').value = '';
                    }
                } else { 
                    alert(json.error); 
                }
            } catch(e) { 
                console.error(e);
                alert("Server Connection Error."); 
            }
        };

        function updateUI(isLoggedIn) {
            if(isLoggedIn) {
                document.getElementById('nav-username').innerText = currentStudent.name;
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                if(currentStudent.hasPaid === 1) {
                    document.getElementById('nav-username').innerHTML += " <span style='background:#27ae60; padding:2px 8px; border-radius:10px; font-size:0.8rem;'>PAID ‚úÖ</span>";
                }
            }
        }

        // --- 4. LOGIN LISTENER ---
        const loginForm = document.getElementById('loginForm');
        if (!loginForm) {
            alert("‚ùå CRITICAL ERROR: I cannot find the Login Form in your HTML!");
        } else {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                
                const index = document.getElementById('login-index').value;
                const pass = document.getElementById('login-pass').value;

                try {
                    const res = await fetch('/login', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ index_number: index, password: pass }) 
                    });

                    const json = await res.json();
                    
                    if(res.ok) {
                        currentStudent = { 
                            name: json.user.name, 
                            index: json.user.index, 
                            hasPaid: json.user.hasPaid 
                        };
                        
                        localStorage.setItem('userIndex', currentStudent.index);
                        localStorage.setItem('userName', currentStudent.name);
                        
                        updateUI(true); // Go to Dashboard

                        // RESTORE GRADES IF THEY EXIST
                        if(json.user.grades) {
                            alert("‚úÖ Welcome back! Loading your saved grades...");
                            localStorage.setItem('savedGrades', JSON.stringify(json.user.grades));
                            restoreForm(json.user.grades);
                        }

                    } else {
                        alert("‚ùå Login Failed: " + json.error);
                    }
                } catch(e) {
                    alert("‚ùå NETWORK ERROR: " + e.message);
                }
            });
        }

        // --- 5. SIGNUP LISTENER ---
        document.getElementById('signupForm').addEventListener('submit', e => { 
            e.preventDefault(); 
            handleAuth('/signup', {
                index_number: document.getElementById('signup-index').value, 
                full_name: document.getElementById('signup-name').value, 
                password: document.getElementById('signup-pass').value
            }, false, 'signupForm'); 
        });

        // --- 6. PAGE LOAD & PAYMENT CHECK ---
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reference')) {
                const savedIndex = localStorage.getItem('userIndex');
                const savedName = localStorage.getItem('userName');
                if (savedIndex) {
                    currentStudent = { name: savedName, index: savedIndex, hasPaid: 1 };
                    updateUI(true);
                    await fetch('/verify-payment', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ index_number: savedIndex }) });
                    restoreAndCalculate();
                    window.history.replaceState({}, document.title, "/");
                }
            }
        });

        // --- 7. CALCULATOR BUTTON ---
        document.getElementById('calculatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            saveFormData(); 
            if (currentStudent.hasPaid === 1) {
                restoreAndCalculate();
            } else {
                initiatePayment();
            }
        });

        // --- 8. LOGIC FUNCTIONS ---
        function saveFormData() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? parseInt(el.value) || 0 : 0;
            };

            const formData = {
                level: document.getElementById('education-level').value,
                mean: document.getElementById('mean-grade').value,
                category: document.getElementById('career-field').value,
                math: getVal('math'),
                eng: getVal('eng'),
                kis: getVal('kis'),
                bio: getVal('bio'),
                phy: getVal('phy'),
                chem: getVal('chem'),
                hist: getVal('hist'),
                geo: getVal('geo'),
                cre: getVal('cre'),
                tech: getVal('tech-subject-grade'),
                techName: document.getElementById('tech-subject-name').value 
            };
            
            localStorage.setItem('savedGrades', JSON.stringify(formData));

            // NEW: SAVE TO SERVER IF LOGGED IN
            if(currentStudent.index !== "0000") {
                fetch('/save-grades', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index_number: currentStudent.index, grades: formData })
                }).then(r => console.log("Grades saved to cloud"));
            }
        }

        function restoreForm(data) {
            if(!data) return;
            try {
                document.getElementById('education-level').value = data.level;
                document.getElementById('mean-grade').value = data.mean;
                document.getElementById('career-field').value = data.category;
                
                const subjects = ['math','eng','kis','bio','phy','chem','hist','geo','cre'];
                subjects.forEach(id => {
                    if(document.getElementById(id)) document.getElementById(id).value = data[id];
                });

                if(data.tech) document.getElementById('tech-subject-grade').value = data.tech;
                if(data.techName) document.getElementById('tech-subject-name').value = data.techName;
            } catch(e) { console.log("Error restoring form", e); }
        }

        async function initiatePayment() {
            const btn = document.querySelector('.primary-btn');
            btn.innerText = "Processing Payment...";
            try {
                const res = await fetch('/pay', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: currentStudent.index + "@student.ke", amount: 50 }) });
                const data = await res.json();
                if (data.authorization_url) window.location.href = data.authorization_url;
            } catch(e) { alert("Payment Error"); btn.innerText = "Calculate & Check"; }
        }

        async function restoreAndCalculate() {
            const saved = JSON.parse(localStorage.getItem('savedGrades'));
            if(!saved) return;

            const g = { math:saved.math, eng:saved.eng, kis:saved.kis, bio:saved.bio, phy:saved.phy, chem:saved.chem, hum1:saved.hist, hum2:saved.geo, hum3:saved.cre, tech:saved.tech };
            let allGrades = Object.values(g).sort((a,b)=>b-a);
            let API = 0; 
            for(let i=0; i<7; i++) API += allGrades[i]; 

            const bestHum = Math.max(g.hum1, g.hum2, g.hum3);
            const bestSci = Math.max(g.bio, g.phy, g.chem);
            
            let R = 0;
            switch(saved.category){
                case 'eng': R = g.math + g.phy + g.chem + g.eng; break;
                case 'med': R = g.bio + g.chem + g.math + g.eng; break;
                case 'law': R = g.eng + g.kis + g.math + Math.max(g.hum1, bestHum); break;
                default: R = g.math + g.eng + bestHum + bestSci; 
            }
            
            const weightedPoints = Math.sqrt((R/48) * (API/84)) * 48;
            currentPoints = weightedPoints.toFixed(3);

            try {
                const res = await fetch('/recommend', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({ points: weightedPoints, category: saved.category, level: saved.level, meanGrade: saved.mean })
                });
                const data = await res.json();
                fetchedCourses = data.results;
                
                document.getElementById('modal-points').innerText = currentPoints;
                document.getElementById('score-modal').classList.remove('hidden');
                document.querySelector('.primary-btn').innerText = "Calculate & Check"; 
            } catch(e) { console.log(e); }
        }

        function viewCourses() {
            document.getElementById('score-modal').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('results-page').classList.remove('hidden');
            
            const cont = document.getElementById('course-list-container');
            cont.innerHTML = "";
            
            if(fetchedCourses && fetchedCourses.length > 0) {
                fetchedCourses.forEach(c => {
                    cont.innerHTML += `<div class="course-card"><h4>${c.name}</h4><p>${c.school} | ${c.cutoff ? 'Cutoff: '+c.cutoff : 'Diploma'}</p></div>`;
                });
            } else {
                cont.innerHTML = "<p style='text-align:center; padding:20px;'>No matching courses found for your cluster points.</p>";
            }
        }
        
        function closeModal(){ document.getElementById('score-modal').classList.add('hidden'); }

        function downloadPDF() {
            const level = document.getElementById('education-level').value.toUpperCase();
            const categoryName = document.getElementById('career-field').options[document.getElementById('career-field').selectedIndex].text;
            
            document.getElementById('pdf-name').innerText = currentStudent.name || "Student";
            document.getElementById('pdf-index').innerText = currentStudent.index || "0000";
            document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
            document.getElementById('pdf-level').innerText = level;
            document.getElementById('pdf-field').innerText = categoryName;
            document.getElementById('pdf-points').innerText = currentPoints;
            
            const tbody = document.getElementById('pdf-course-list');
            tbody.innerHTML = "";
            if(fetchedCourses.length > 0) {
                fetchedCourses.slice(0, 15).forEach(c => {
                    tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.school}</td><td>${c.cutoff ? c.cutoff : 'Qualified'}</td></tr>`;
                });
            } else { tbody.innerHTML = "<tr><td colspan='3'>No courses found.</td></tr>"; }

            const element = document.getElementById('pdf-template');
            element.style.display = 'block'; 
            html2pdf().set({ margin:10, filename:`Career_Report_${currentStudent.index}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(element).save().then(() => { element.style.display = 'none'; });
        }
    </script>
</body>
</html>